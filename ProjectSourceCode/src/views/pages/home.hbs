{{>message}}
<title>Buff's Bulletin</title>
<main role="main" class="d-flex flex-column vh-100">
  <!-- Page Heading (fixed height) -->
  <div class="mb-1 text-center">
    <h1 class="display-6">Welcome to Buff's Bulletin!</h1>
    <p class="lead text-muted small">See what's happening around campus</p>
  </div>
  
  <!-- Layout: Sidebar + Map (fills remaining height) -->
  <div class="d-flex flex-grow-1 overflow-hidden">
    <!-- Sidebar -->
      <div id="sidebar" class="bg-light border-end d-flex flex-column gap-2 p-2">
        {{> new_event}}
        <!-- Fixed top content -->
        <div class="d-flex align-items-center justify-content-between gap-2">
          <button class="btn btn-sm btn-outline-secondary" id="expandSidebarBtn">Expand</button>
          {{#if user.useradmin}}
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#event_modal">
            Create Event
          </button>
          {{/if}}
        </div>
 

        <h2 class="events-title">Events</h2>

        <div>
          <div class="mb-3">
            <label for="date-filter" class="form-label">Show events for:</label>
            <select id="date-filter" class="form-select">
              <option value="today" selected>Today</option>
              <option value="today-tomorrow">Today & Tomorrow</option>
              <option value="next-week">Next 7 Days</option>
              <option value="next-month">Next 30 Days</option>
            </select>
          </div>

          <button id="sidebar-submit-button" class="btn btn-primary" onclick="handleDateFilterSubmit()">Submit</button>
        </div>

    
        <!-- Scrollable Event List container -->
        <div class="sidebar-scroll-container"></div>
      </div>

    <!-- Map -->
    <div id="map-container" class="flex-grow-1 position-relative" style="height: 100%;">
      {{>map}}
    </div>
  </div>
</main>

<script>
  window.geoEvents = {{{json geoEvents}}};
</script>

<script src="/js/map.js"></script>


<script>
  function submitFromElement(el) {
    const id   = el.dataset.eventid;                       // "4"
    const form = document.getElementById(`eventForm-${id}`);
    if (!form) return;

    /* NEW ─ copy the id into the hidden input */
    const hidden = form.querySelector('input[name="eventID"]');
    if (hidden) hidden.value = id;                         // ← ★

    form.submit();
  }
</script>

<script id="sidebar-template" type="text/x-handlebars-template">
  <ul class="list-group">
    \{{#each fetchedEvents}}
    <li class="list-group-item event-item sidebar-item" id="sidebar-item-\{{eventid}}" data-eventid="\{{eventid}}"
      onclick="submitFromElement(this)" onkeydown="if(event.key === 'Enter') submitFromElement(this)" role="button"
      tabindex="0">
      <div class="w-100">
        <strong class="fs-5">\{{eventname}}</strong><br />
        <p class="mb-0"><strong>Location:</strong>
          \{{building}}
          Room
          \{{roomnumber}}</p>
        <p class="mb-0"><strong>Hosted by:</strong> \{{clubsponser}}</p>
  
        <!-- Individual form per event -->
        <form id="eventForm-\{{eventid}}" action="/event-details" method="GET" target="_blank" style="display: none;">
          <input type="hidden" name="eventID" value="{{eventid}}" />
        </form>
  
        <div class="sidebar-extra mt-2">
          <small class="text-muted">\{{eventdescription}}</small>
        </div>
  
        <small class="text-muted">
          \{{eventDateFormatted}}
          —
          <span class="d-inline-block">\{{startTimeFormatted}}
            to
            \{{endTimeFormatted}}</span>
        </small>
  
      </div>
    </li>
    \{{/each}}
  </ul>
</script>

<script type="text/javascript">
  const sidebarRender = document.querySelector('#sidebar-template');
  const sidebarContentContainer = document.querySelector('.sidebar-scroll-container');
  const sidebarSubmitButton = document.querySelector('#sidebar-submit-button');

  document.addEventListener('DOMContentLoaded', () => {
    const events = {{{json events}}};

    //grab <script id="sidebar-template">
    const templateEl = document.querySelector('#sidebar-template');
    const sidebarContainer = document.querySelector('.sidebar-scroll-container');

    //strip ONE leading back‑slash
    const tplSource = templateEl.innerHTML.replace(/\\(\{\{[^}]+\}\})/g, '$1');

    //Compile and render
    const sidebarTpl = Handlebars.compile(tplSource);
    sidebarContainer.innerHTML = sidebarTpl({ fetchedEvents: events });
  });

  function handleDateFilterSubmit() {
    const filterSelect = document.querySelector('#date-filter');
    const filterValue = filterSelect.value;

    let startDate = new Date();
    let endDate = new Date();

    switch (filterValue) {
      case 'today':
        // Do nothing: same day
        break;
      case 'today-tomorrow':
        endDate.setDate(startDate.getDate() + 1);
        break;
      case 'next-week':
        endDate.setDate(startDate.getDate() + 7);
        break;
      case 'next-month':
        endDate.setDate(startDate.getDate() + 30);
        break;
    }

    const params = new URLSearchParams({
      startDate: startDate.toISOString().slice(0, 10),
      endDate: endDate.toISOString().slice(0, 10)
    });

    fetch(`/get-events?${params}`)
      .then(result => result.json())
      .then(({ events, geoEvents }) => {
        const htmlString = Handlebars.compile(sidebarRender.innerHTML)({
          fetchedEvents: events
        });
        sidebarContentContainer.innerHTML = htmlString;
        addMarkers(geoEvents);
      })
      .catch(err => console.error("Error fetching events:", err));
  }

  function getEvents(startTime, endTime) {
    const params = new URLSearchParams({
      startTime,
      endTime
    });

    const getEventsUrl = `/get-events?${params}`;

    fetch(getEventsUrl)
      .then((result) => result.json())
      .then(({
        events,
        geoEvents
      }) => {
        console.log(geoEvents)
        const htmlString = Handlebars.compile(sidebarRender.innerHTML)({
          fetchedEvents: events
        });
        sidebarContentContainer.innerHTML = htmlString;

        addMarkers(geoEvents);
      })
  }

  function handleTimeSubmit() {
    const currentDate = new Date();

    const startTimeInput = document.querySelector('#start-time');
    const endTimeInput = document.querySelector('#end-time');

    getEvents(`${startTimeInput.value}:00`, `${endTimeInput.value}:00`);
  }
</script>
